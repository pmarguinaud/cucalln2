SUBROUTINE CUININ_OPENACC (YDCST, YDTHF, YDEPHLI, YDECUMF, KIDIA, KFDIA, KLON&
&, KLEV, PTEN, PQEN, PQSEN, PUEN, PVEN, PGEO, PAPH, KLAB, PTENH, PQENH, PQSENH&
&, PGEOH, PTU, PQU, PTD, PQD, PUU, PVU, PUD, PVD, PLU, YDSTACK)
!$acc routine (CUININ_OPENACC) seq
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOECUMF,ONLY:TECUMF
USE YOEPHLI,ONLY:TEPHLI
USE ABOR1_ACC_MOD
USE STACK_MOD
#include "stack.h"

IMPLICIT NONE

TYPE (TCST), INTENT (IN)::YDCST
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PTEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQSEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
INTEGER (KIND=JPIM), INTENT (OUT)::KLAB (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQSENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PTU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PTD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PUU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PVU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PUD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PVD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLU (KLON, KLEV)
TYPE(STACK) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL (KIND=JPRB)::ZPH 
LOGICAL::LLFLAG 

INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::IK
REAL (KIND=JPRB)::ZORCPD

#include "cuadjtq.func.h"
#include "fcttre.func.h"

REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZQMAX
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::Z1S
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZI
REAL (KIND=JPRB)::ZL
LOGICAL::LLFLAG_CUADJTQ 
REAL (KIND=JPRB)::ZALDCP 
REAL (KIND=JPRB)::Z5ALCP 
REAL (KIND=JPRB)::Z4ES 
REAL (KIND=JPRB)::Z3ES 
REAL (KIND=JPRB)::Z2S_CUADJTQS
REAL (KIND=JPRB)::ZFOEEW
REAL (KIND=JPRB)::ZQSAT_CUADJTQS
REAL (KIND=JPRB)::ZCOR_CUADJTQS
REAL (KIND=JPRB)::ZTARG_CUADJTQS
REAL (KIND=JPRB)::ZCOND1_CUADJTQS
REAL (KIND=JPRB)::ZCOND_CUADJTQS
REAL (KIND=JPRB)::ZQP_CUADJTQS
REAL (KIND=JPRB)::ZQMAX_CUADJTQS

YLSTACK = YDSTACK




JLON = KIDIA


ZORCPD=1._JPRB/YDCST%RCPD

DO JLEV=2, KLEV
  
  PTENH (JLON, JLEV)=(MAX (YDCST%RCPD*PTEN (JLON, JLEV-1)+PGEO (JLON, JLEV-1), YDCST&
  &%RCPD*PTEN (JLON, JLEV)+PGEO (JLON, JLEV))-PGEOH (JLON, JLEV))*ZORCPD
  PQENH (JLON, JLEV)=PQEN (JLON, JLEV-1)
  PQSENH (JLON, JLEV)=PQSEN (JLON, JLEV-1)
  ZPH =PAPH (JLON, JLEV)
  LLFLAG =.TRUE.

  

  IF (JLEV>=KLEV-1.OR.JLEV<YDECUMF%NJKT2)  THEN
      CYCLE
  ENDIF

  IK=JLEV

  IF (YDEPHLI%LPHYLIN) THEN
    
    
    
    
    
    
    
    
    ZQMAX_CUADJTQS=0.5_JPRB

    

    IF (PTENH (JLON, IK)>YDCST%RTT) THEN
      Z3ES =YDTHF%R3LES
      Z4ES =YDTHF%R4LES
      Z5ALCP =YDTHF%R5ALVCP
      ZALDCP =YDTHF%RALVDCP
    ELSE
      Z3ES =YDTHF%R3IES
      Z4ES =YDTHF%R4IES
      Z5ALCP =YDTHF%R5ALSCP
      ZALDCP =YDTHF%RALSDCP
    ENDIF

    
    
    
    
    
    ZQP_CUADJTQS=1.0_JPRB/ZPH 
    ZTARG_CUADJTQS=PTENH (JLON, IK)
    ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG_CUADJTQS-YDCST%RTT)/(ZTARG_CUADJTQS-Z4ES ))
    ZQSAT_CUADJTQS=ZQP_CUADJTQS*ZFOEEW

    IF (ZQSAT_CUADJTQS>ZQMAX_CUADJTQS) THEN
      ZQSAT_CUADJTQS=ZQMAX_CUADJTQS
    ENDIF

    ZCOR_CUADJTQS=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT_CUADJTQS)
    ZQSAT_CUADJTQS=ZQSAT_CUADJTQS*ZCOR_CUADJTQS
    Z2S_CUADJTQS=Z5ALCP /(ZTARG_CUADJTQS-Z4ES )**2
    ZCOND1_CUADJTQS=(PQSENH (JLON, IK)-ZQSAT_CUADJTQS)/(1&
    &.0_JPRB+ZQSAT_CUADJTQS*ZCOR_CUADJTQS*Z2S_CUADJTQS)
    PTENH (JLON, IK)=PTENH (JLON, IK)+ZALDCP *ZCOND1_CUADJTQS
    PQSENH (JLON, IK)=PQSENH (JLON, IK)-ZCOND1_CUADJTQS
    ZTARG_CUADJTQS=PTENH (JLON, IK)
    ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG_CUADJTQS-YDCST%RTT)/(ZTARG_CUADJTQS-Z4ES ))
    ZQSAT_CUADJTQS=ZQP_CUADJTQS*ZFOEEW

    IF (ZQSAT_CUADJTQS>ZQMAX_CUADJTQS) THEN
      ZQSAT_CUADJTQS=ZQMAX_CUADJTQS
    ENDIF

    ZCOR_CUADJTQS=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT_CUADJTQS)
    ZQSAT_CUADJTQS=ZQSAT_CUADJTQS*ZCOR_CUADJTQS
    Z2S_CUADJTQS=Z5ALCP /(ZTARG_CUADJTQS-Z4ES )**2
    ZCOND1_CUADJTQS=(PQSENH (JLON, IK)-ZQSAT_CUADJTQS)/(1&
    &.0_JPRB+ZQSAT_CUADJTQS*ZCOR_CUADJTQS*Z2S_CUADJTQS)
    PTENH (JLON, IK)=PTENH (JLON, IK)+ZALDCP *ZCOND1_CUADJTQS
    PQSENH (JLON, IK)=PQSENH (JLON, IK)-ZCOND1_CUADJTQS
  
  
  
  
  
  
  
  ELSE
    
    
    
    
    
    
    
    ZQMAX=0.5_JPRB

    IF (.NOT.YDEPHLI%LPHYLIN) THEN
      
      
      
      
      
      
      
      ZQP=1.0_JPRB/ZPH 
      ZQSAT=FOEEWMCU (PTENH (JLON, IK))*ZQP
      ZQSAT=MIN (0.5_JPRB, ZQSAT)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      ZCOND1=(PQSENH (JLON, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (PTENH (JLON, IK)))
      PTENH (JLON, IK)=PTENH (JLON, IK)+FOELDCPMCU (PTENH (JLON, IK))*ZCOND1
      PQSENH (JLON, IK)=PQSENH (JLON, IK)-ZCOND1
      ZQSAT=FOEEWMCU (PTENH (JLON, IK))*ZQP
      ZQSAT=MIN (0.5_JPRB, ZQSAT)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      ZCOND1=(PQSENH (JLON, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (PTENH (JLON, IK)))
      PTENH (JLON, IK)=PTENH (JLON, IK)+FOELDCPMCU (PTENH (JLON, IK))*ZCOND1
      PQSENH (JLON, IK)=PQSENH (JLON, IK)-ZCOND1
    
    
    ELSE
    
    
    
    
    ENDIF

  
  
  
  ENDIF

  
  PQENH (JLON, JLEV)=MIN (PQEN (JLON, JLEV-1), PQSEN (JLON&
  &, JLEV-1))+(PQSENH (JLON, JLEV)-PQSEN (JLON, JLEV-1))
  PQENH (JLON, JLEV)=MAX (PQENH (JLON, JLEV), 0.0_JPRB)
  
ENDDO


PTENH (JLON, KLEV)=(YDCST%RCPD*PTEN (JLON, KLEV)+PGEO (JLON, KLEV)-PGEOH (JLON, KLEV))*ZORCPD
PQENH (JLON, KLEV)=PQEN (JLON, KLEV)
PTENH (JLON, 1)=PTEN (JLON, 1)
PQENH (JLON, 1)=PQEN (JLON, 1)


DO JLEV=1, KLEV
  IK=JLEV-1

  IF (JLEV==1)  THEN
      IK=1
  ENDIF

  
  PTU (JLON, JLEV)=PTENH (JLON, JLEV)
  PTD (JLON, JLEV)=PTENH (JLON, JLEV)
  PQU (JLON, JLEV)=PQENH (JLON, JLEV)
  PQD (JLON, JLEV)=PQENH (JLON, JLEV)
  PLU (JLON, JLEV)=0.0_JPRB
  PUU (JLON, JLEV)=PUEN (JLON, IK)
  PUD (JLON, JLEV)=PUEN (JLON, IK)
  PVU (JLON, JLEV)=PVEN (JLON, IK)
  PVD (JLON, JLEV)=PVEN (JLON, IK)
  KLAB (JLON, JLEV)=0
  
ENDDO



ENDSUBROUTINE CUININ_OPENACC

! e56ac8e1f86b1a9cc13b38d73abbf48f96ba2f2a
